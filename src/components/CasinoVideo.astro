---
import casinoVideo from "../assets/casino.webm"
---

<!-- Casino Video Overlay -->
<div class="casino-overlay" id="casino-overlay">
  <div class="casino-video-container">
    <video id="casino-video" playsinline preload="auto">
      <source src={casinoVideo} type="video/webm" />
      Your browser does not support the video tag.
    </video>
  </div>
</div>

<style>
  /* Casino Video Overlay */
  .casino-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .casino-overlay.active {
    display: flex;
    opacity: 1;
  }

  .casino-video-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .casino-video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>

<script>
  // Casino video functionality
  function showCasinoVideo() {
    const overlay = document.getElementById("casino-overlay")
    const video = document.getElementById(
      "casino-video",
    ) as HTMLVideoElement | null
    if (!overlay || !video) return

    // Show overlay
    overlay.classList.add("active")
    document.body.style.overflow = "hidden"

    // Play video with sound (user has already interacted with the page)
    video
      .play()
      .then(() => {
        console.log("Casino video playing with sound")
      })
      .catch((err) => {
        console.error("Error playing video:", err)
      })
  }

  // Check if letter_game_count is 14 and trigger video
  function checkLetterGameCount() {
    const count = localStorage.getItem("letter_game_count")
    const videoShown = sessionStorage.getItem("casino_video_shown")

    if (count === "14" && !videoShown) {
      // Mark as shown in this session to prevent repeated triggers
      sessionStorage.setItem("casino_video_shown", "true")
      showCasinoVideo()
    }
  }

  // Progressive video preloading
  function preloadCasinoVideo() {
    const video = document.getElementById(
      "casino-video",
    ) as HTMLVideoElement | null
    if (!video) return

    // Use requestIdleCallback for progressive loading
    if ("requestIdleCallback" in window) {
      requestIdleCallback(
        () => {
          // Set preload to auto to start loading the video
          video.preload = "auto"
        },
        { timeout: 5000 },
      )
    } else {
      // Fallback for browsers without requestIdleCallback
      setTimeout(() => {
        video.preload = "auto"
      }, 5000)
    }
  }

  // Make functions globally available
  ;(window as any).showCasinoVideo = showCasinoVideo
  ;(window as any).preloadCasinoVideo = preloadCasinoVideo

  // Listen for casino-video-trigger event
  window.addEventListener("casino-video-trigger", () => {
    showCasinoVideo()
  })

  // Listen for localStorage changes (from other tabs/windows)
  window.addEventListener("storage", (e) => {
    if (e.key === "letter_game_count" && e.newValue === "14") {
      checkLetterGameCount()
    }
  })

  // Auto-initialize on page load
  document.addEventListener("astro:page-load", () => {
    preloadCasinoVideo()
    checkLetterGameCount()

    // Also check periodically in case localStorage changes in same tab
    const interval = setInterval(() => {
      checkLetterGameCount()
    }, 500)

    // Store interval ID to clean up later if needed
    ;(window as any).casinoCheckInterval = interval
  })

  if (document.readyState === "complete") {
    preloadCasinoVideo()
    checkLetterGameCount()
  } else {
    document.addEventListener("DOMContentLoaded", () => {
      preloadCasinoVideo()
      checkLetterGameCount()
    })
  }
</script>
