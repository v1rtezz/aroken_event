<div class="letter-widget">
  <button class="letter-widget-btn" data-letter-btn>
    <svg
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <path d="M4 7V4h16v3"></path>
      <path d="M9 20h6"></path>
      <path d="M12 4v16"></path>
    </svg>
  </button>

  <div class="letter-dropdown" data-letter-dropdown>
    <div class="letter-container">
      <div class="letter-header">
        <h3 class="letter-title">–ù–∞–π–¥–∏ –±—É–∫–≤—ã</h3>
      </div>
      <div class="letter-content">
        <div class="letter-progress">
          –ù–∞–π–¥–µ–Ω–æ <span id="letter-count">0</span>/14
        </div>
        <div class="letter-input-group">
          <input
            type="text"
            id="letter-input"
            class="letter-input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –±—É–∫–≤—É"
            maxlength="1"
          />
        </div>
        <div class="letter-message" id="letter-message"></div>
        <div class="letter-sequence">
          <div class="letter-sequence-label">–ù–∞–π–¥–µ–Ω–Ω—ã–µ –±—É–∫–≤—ã:</div>
          <div class="letter-sequence-display" id="letter-sequence-display">
            * * * * * * * * * * * * * *
          </div>
        </div>
        <button class="letter-reset-btn" id="reset-btn">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<style>
  .letter-widget {
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .letter-widget-btn {
    width: 3.5vw;
    height: 3.5vw;
    border-radius: 50%;
    background: var(--theme-bg-hard, #1e1e1e);
    border: 1px solid var(--theme-border, #2d2d2d);
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }

  .letter-widget-btn svg {
    width: 1.75vw;
    height: 1.75vw;
    transition: all 0.3s;
  }

  .letter-widget-btn:hover {
    background: var(--theme-accent-softer, #3d3d3d);
    border-color: var(--theme-accent-softer, #3d3d3d);
    transform: scale(1.1);
  }

  .letter-dropdown {
    position: absolute;
    right: calc(100% + 12px);
    top: 50%;
    transform: translateY(-50%);
    z-index: 1001;
    border-radius: 0.5rem;
    border: 1px solid var(--theme-border, #2d2d2d);
    background: var(--theme-bg-hard, #1e1e1e);
    padding: 0;
    min-width: 400px;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    transition:
      translate 0.3s,
      opacity 0.3s,
      scale 0.3s,
      visibility 0.3s;
    translate: 10px -50%;
    transform-origin: right center;
    opacity: 0;
    scale: 0.8;
    visibility: hidden;
    box-shadow: 0 0 20px 3px rgba(0, 0, 0, 0.5);
  }

  .letter-dropdown--active {
    translate: 0 -50%;
    opacity: 1;
    scale: 1;
    visibility: visible;
  }

  .letter-container {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 20px;
    display: flex;
    flex-direction: column;
  }

  .letter-header {
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #2d2d2d;
  }

  .letter-title {
    color: #e0e0e0;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    font-family:
      -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  .letter-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .letter-progress {
    color: #e0e0e0;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
  }

  .letter-progress span {
    color: #4a9eff;
  }

  .letter-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .letter-input {
    width: 100%;
    padding: 12px;
    background: #252525;
    color: #e0e0e0;
    border: 1px solid #3d3d3d;
    border-radius: 8px;
    font-size: 24px;
    font-weight: 600;
    text-align: center;
    text-transform: uppercase;
    outline: none;
    transition: border-color 0.3s;
    box-sizing: border-box;
    font-family: "Courier New", monospace;
  }

  .letter-input:focus {
    border-color: #4a9eff;
  }

  .letter-input::placeholder {
    color: #6b6b6b;
  }

  .letter-message {
    min-height: 24px;
    color: #e0e0e0;
    font-size: 14px;
    text-align: center;
    font-weight: 500;
  }

  .letter-message.success {
    color: #4a9eff;
  }

  .letter-message.error {
    color: #ff6b6b;
  }

  .letter-sequence {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .letter-sequence-label {
    color: #e0e0e0;
    font-size: 14px;
    font-weight: 500;
  }

  .letter-sequence-display {
    color: #e0e0e0;
    font-size: 18px;
    font-weight: 600;
    font-family: "Courier New", monospace;
    letter-spacing: 4px;
    text-align: center;
    padding: 12px;
    background: #252525;
    border-radius: 8px;
  }

  .letter-reset-btn {
    padding: 10px 16px;
    background: #252525;
    color: #e0e0e0;
    border: 1px solid #3d3d3d;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
  }

  .letter-reset-btn:hover {
    background: #3d3d3d;
    border-color: #4a9eff;
  }
</style>

<script>
  // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å (14 —Å–∏–º–≤–æ–ª–æ–≤)
  const TARGET_SEQUENCE = "AROKENFIBERSON"
  const STORAGE_KEY = "letter_game_progress"
  const COUNT_STORAGE_KEY = "letter_game_count"

  let closeHandler: ((e: Event) => void) | null = null

  function initLetterGame() {
    const btn = document.querySelector("[data-letter-btn]")
    const dropdown = document.querySelector("[data-letter-dropdown]")
    const input = document.getElementById(
      "letter-input",
    ) as HTMLInputElement | null
    const message = document.getElementById("letter-message")
    const count = document.getElementById("letter-count")
    const sequenceDisplay = document.getElementById("letter-sequence-display")
    const resetBtn = document.getElementById("reset-btn")

    if (
      !btn ||
      !dropdown ||
      !input ||
      !message ||
      !count ||
      !sequenceDisplay ||
      !resetBtn
    ) {
      return
    }

    let foundLetters: string[] = [] // –ú–∞—Å—Å–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –±—É–∫–≤

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–∑ localStorage
    function loadProgress() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY)
        if (saved) {
          const data = JSON.parse(saved)
          foundLetters = data.foundLetters || []
          updateDisplay()
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:", e)
        foundLetters = []
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ localStorage
    function saveProgress() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ foundLetters }))
        localStorage.setItem(COUNT_STORAGE_KEY, foundLetters.length.toString())
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:", e)
      }
    }

    // –ü–æ–¥—Å—á–µ—Ç –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ü–µ–ª–µ–≤–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    function getRemainingChars() {
      const remaining: Record<string, number> = {}
      for (let char of TARGET_SEQUENCE) {
        remaining[char] = (remaining[char] || 0) + 1
      }
      for (let char of foundLetters) {
        if (remaining[char]) {
          remaining[char]--
        }
      }
      return remaining
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function updateDisplay() {
      if (!count || !sequenceDisplay || !input) return

      count.textContent = foundLetters.length.toString()

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      const displayParts: string[] = []
      const tempFound = [...foundLetters]

      for (let i = 0; i < TARGET_SEQUENCE.length; i++) {
        const char = TARGET_SEQUENCE[i]
        const index = tempFound.indexOf(char)

        if (index !== -1) {
          displayParts.push(char)
          tempFound.splice(index, 1)
        } else {
          displayParts.push("*")
        }
      }

      sequenceDisplay.textContent = displayParts.join(" ")

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
      if (foundLetters.length >= TARGET_SEQUENCE.length) {
        showMessage("üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –í—ã —Å–æ–±—Ä–∞–ª–∏ –≤—Å—é —Ñ—Ä–∞–∑—É!", "success")
        input.disabled = true
        // Trigger casino video
        window.dispatchEvent(new CustomEvent("casino-video-trigger"))
      }
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    function showMessage(text: string, type: string) {
      if (!message) return
      message.textContent = text
      message.className = "letter-message"
      if (type) {
        message.classList.add(type)
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞
    function checkInput() {
      if (!input) return

      if (foundLetters.length >= TARGET_SEQUENCE.length) {
        showMessage("–í—Å–µ –±—É–∫–≤—ã —É–∂–µ –Ω–∞–π–¥–µ–Ω—ã!", "error")
        return
      }

      const userInput = input.value

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ–±–µ–ª
      if (userInput === " " || userInput === "") {
        const remaining = getRemainingChars()
        if (remaining[" "] && remaining[" "] > 0) {
          foundLetters.push(" ")
          saveProgress()
          updateDisplay()
          showMessage("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "success")
          input.value = ""
          return
        } else {
          showMessage("–ù–µ–≤–µ—Ä–Ω–æ!", "error")
          return
        }
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É–∫–≤—ã
      const userChar = userInput.toUpperCase()

      if (!userChar) {
        showMessage("", "")
        return
      }

      const remaining = getRemainingChars()

      if (remaining[userChar] && remaining[userChar] > 0) {
        foundLetters.push(userChar)
        saveProgress()
        updateDisplay()
        showMessage("–ü—Ä–∞–≤–∏–ª—å–Ω–æ!", "success")
        input.value = ""

        // Check if player has found the required letters: A, R, O, K, E, N, F
        const requiredLetters = ["A", "R", "O", "K", "E", "N", "F"]
        const hasAllRequired = requiredLetters.every((letter) =>
          foundLetters.includes(letter),
        )

        // Check if we haven't triggered this yet
        const devtoolsTriggered = localStorage.getItem("devtools_triggered")

        if (hasAllRequired && !devtoolsTriggered) {
          // Mark as triggered so it doesn't repeat
          localStorage.setItem("devtools_triggered", "true")

          // Trigger Aroken with devtools.wav audio
          const event = new CustomEvent("aroken-trigger", {
            detail: {
              audioPath: "/devtools.wav",
              duration: 10000, // 10 seconds for the audio to play
              subtitles:
                "–±—Ä–∞—Ç, –∂–æ–ø–æ–π —á—É—é —á—Ç–æ –Ω–∞ –≤–∏–¥–Ω–æ–º –º–µ—Å—Ç–µ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç. –ú–æ–∂–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥–ª—è–Ω—É—Ç—å –ø–æ–≥–ª—É–±–∂–µ? –ö—É–¥–∞ –æ–±—ã—á–Ω—ã–π —é–∑–µ—Ä –±—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ª–µ–∑, –∞ –µ—Å–ª–∏ –±—ã –∑–∞–ª–µ–∑ - —Å—Ä–∞–∑—É –±—ã –≤—ã—à–µ–ª",
            },
          })
          window.dispatchEvent(event)
        }

        // Check if player has found 10 letters
        const prefinalTriggered = localStorage.getItem("prefinal_triggered")

        if (foundLetters.length === 9 && !prefinalTriggered) {
          // Mark as triggered so it doesn't repeat
          localStorage.setItem("prefinal_triggered", "true")

          // Trigger Aroken with prefinal.wav audio
          const event = new CustomEvent("aroken-trigger", {
            detail: {
              audioPath: "/prefinal.wav",
              duration: 23000, // 23 seconds for the audio to play
              subtitles:
                "–ú–∞—à–∏–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —ç—Ç–æ –≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–∏–µ, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–µ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–æ—à–ª–æ–µ –∏–ª–∏ –±—É–¥—É—â–µ–µ, –≤–æ–ø—Ä–µ–∫–∏ –µ–≥–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É –æ–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º—É —Ç–µ—á–µ–Ω–∏—é. –†–∞–∑—É–º–µ–µ—Ç—Å—è, –º–∞—à–∏–Ω—ã –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ —è —á—É–≤—Å—Ç–≤—É—é, —á—Ç–æ —Ç—ã –≤—Å–µ —Ç–∞–∫–∏ –º–æ–∂–µ—à—å –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞–∑–∞–¥.. –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ –≤—Å–ø–ª–∞–∫–Ω—É—Ç —Å—Ç–∞—Ä—ã–µ —É—á–µ–Ω–∏–∫–∏, –∞ –Ω–æ–≤—ã–µ –¥–∞–∂–µ –Ω–µ –ø–æ–π–º—É—Ç –æ —á–µ–º —Ä–µ—á—å..",
            },
          })
          window.dispatchEvent(event)
        }
      } else {
        showMessage("–ù–µ–≤–µ—Ä–Ω–æ!", "error")
      }
    }

    // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    function resetProgress() {
      if (!input) return
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?")) {
        foundLetters = []
        saveProgress()
        updateDisplay()
        showMessage("", "")
        input.disabled = false
        input.value = ""
        input.focus()
        // Reset trigger flags
        localStorage.removeItem("devtools_triggered")
        localStorage.removeItem("prefinal_triggered")
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä—É–≥–∏—Ö dropdown
    function closeOtherDropdowns() {
      const otherDropdowns = document.querySelectorAll(
        "[data-notes-dropdown], [data-claude-dropdown], [data-binary-dropdown]",
      )
      otherDropdowns.forEach((otherDropdown) => {
        otherDropdown.classList.remove("notes-dropdown--active")
        otherDropdown.classList.remove("claude-dropdown--active")
        otherDropdown.classList.remove("binary-dropdown--active")
      })
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ dropdown
    btn.addEventListener("click", (e) => {
      e.stopPropagation()
      const isActive = dropdown.classList.contains("letter-dropdown--active")
      closeOtherDropdowns()

      if (isActive) {
        dropdown.classList.remove("letter-dropdown--active")
      } else {
        dropdown.classList.add("letter-dropdown--active")
        input?.focus()
      }
    })

    // Clean up old listener if exists
    if (closeHandler) {
      document.removeEventListener("click", closeHandler)
    }

    // Define new handler
    closeHandler = (e: Event) => {
      if (
        !dropdown.contains(e.target as Node) &&
        !btn.contains(e.target as Node)
      ) {
        dropdown.classList.remove("letter-dropdown--active")
      }
    }

    // Add new listener
    document.addEventListener("click", closeHandler)

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
    input.addEventListener("input", checkInput)

    // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
    resetBtn.addEventListener("click", resetProgress)

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadProgress()
  }

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  document.addEventListener("astro:page-load", initLetterGame)
  // Fallback for initial load if ViewTransitions not active or script runs late
  if (document.readyState === "complete") {
    initLetterGame()
  } else {
    document.addEventListener("DOMContentLoaded", initLetterGame)
  }
</script>
